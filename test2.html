<!DOCTYPE html>
<html>
<head>
    <title>Firebase 联机井字棋</title>
    <style>
        .board {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            gap: 5px;
            margin: 20px;
        }
        .cell {
            width: 100px;
            height: 100px;
            border: 2px solid #333;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            cursor: pointer;
            background: #fff;
        }
        .status {
            font-size: 24px;
            margin: 20px;
        }
        .reset-btn {
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
        }
    </style>
    <!-- 加入 Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <div class="status" id="status">等待连接...</div>
    <div class="board" id="board"></div>
    <button class="reset-btn" onclick="resetGame()">重新开始</button>

    <script>
        // 替换为你的 Firebase 配置
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            projectId: "test-8a5cb",
            databaseURL: "https://test-8a5cb.firebaseio.com",
            // 可能需要添加其他配置参数
        };

        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let currentPlayer;
        let gameId = "publicGame"; // 公共游戏房间ID
        let playerSymbol;
        let isGameActive = true;

        // 初始化游戏
        function initGame() {
            // 创建棋盘
            const board = document.getElementById('board');
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.setAttribute('data-index', i);
                cell.addEventListener('click', handleCellClick);
                board.appendChild(cell);
            }

            // 监听游戏状态
            database.ref(`games/${gameId}`).on('value', (snapshot) => {
                const gameState = snapshot.val();
                if (gameState) {
                    updateBoard(gameState.board);
                    currentPlayer = gameState.currentPlayer;
                    
                    // 自动分配玩家符号
                    if (!playerSymbol) {
                        playerSymbol = gameState.players === 1 ? 'X' : 'O';
                        document.getElementById('status').textContent = 
                            `你扮演 ${playerSymbol} | 当前玩家: ${currentPlayer}`;
                    }

                    checkWinner(gameState.board);
                }
            });
        }

        // 处理格子点击
        function handleCellClick(e) {
            if (!isGameActive || playerSymbol !== currentPlayer) return;

            const index = e.target.getAttribute('data-index');
            const gameRef = database.ref(`games/${gameId}`);
            
            gameRef.transaction((gameState) => {
                if (gameState && !gameState.board[index] && !gameState.winner) {
                    gameState.board[index] = playerSymbol;
                    gameState.currentPlayer = gameState.currentPlayer === 'X' ? 'O' : 'X';
                    gameState.players = Math.min(gameState.players || 0 + 1, 2);
                }
                return gameState;
            });
        }

        // 更新棋盘显示
        function updateBoard(board) {
            const cells = document.querySelectorAll('.cell');
            cells.forEach((cell, index) => {
                cell.textContent = board ? board[index] || '' : '';
            });
        }

        // 检查胜利条件
        function checkWinner(board) {
            const winPatterns = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // 行
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // 列
                [0, 4, 8], [2, 4, 6] // 对角线
            ];

            for (const pattern of winPatterns) {
                const [a, b, c] = pattern;
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    endGame(`${board[a]} 胜利!`);
                    return;
                }
            }

            if (board.every(cell => cell)) {
                endGame("平局!");
            }
        }

        function endGame(message) {
            isGameActive = false;
            document.getElementById('status').textContent = message;
<!DOCTYPE html>
<html>
<head>
    <title>Firebase 联机井字棋</title>
    <style>
        .board {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            gap: 5px;
            margin: 20px;
        }
        .cell {
            width: 100px;
            height: 100px;
            border: 2px solid #333;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            cursor: pointer;
            background: #fff;
        }
        .status {
            font-size: 24px;
            margin: 20px;
        }
        .reset-btn {
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="status" id="status">等待玩家连接...</div>
    <div class="board" id="board"></div>
    <button class="reset-btn" onclick="resetGame()">重新开始</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, runTransaction } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAqbA4PN7uJr_lnIRHeqvvLJQXOHHoZW4E",
            authDomain: "test-8a5cb.firebaseapp.com",
            databaseURL: "https://test-8a5cb-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "test-8a5cb",
            storageBucket: "test-8a5cb.firebasestorage.app",
            messagingSenderId: "227317352826",
            appId: "1:227317352826:web:90d96f27a4dc5d96c16ec3",
            measurementId: "G-EMJ5ZVJXBE"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const gameId = "publicMatch";
        let playerSymbol = null;
        let isGameActive = true;

        // 初始化棋盘
        const boardElement = document.getElementById('board');
        for (let i = 0; i < 9; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.index = i;
            cell.addEventListener('click', handleMove);
            boardElement.appendChild(cell);
        }

        // 监听游戏状态
        const gameRef = ref(db, `games/${gameId}`);
        onValue(gameRef, (snapshot) => {
            const gameState = snapshot.val() || {
                board: Array(9).fill(null),
                currentPlayer: 'X',
                players: 0,
                winner: null
            };

            updateBoard(gameState.board);
            updateStatus(gameState);

            if (!playerSymbol && gameState.players < 2) {
                playerSymbol = gameState.players === 0 ? 'X' : 'O';
                set(gameRef, { 
                    ...gameState,
                    players: gameState.players + 1 
                });
            }

            checkWinner(gameState);
        });

        // 处理玩家移动
        function handleMove(e) {
            if (!isGameActive || !playerSymbol) return;
            
            const index = parseInt(e.target.dataset.index);
            const currentCell = document.querySelector(`[data-index="${index}"]`);
            if (currentCell.textContent) return;

            runTransaction(gameRef, (gameState) => {
                if (!gameState || gameState.winner || gameState.currentPlayer !== playerSymbol) 
                    return gameState;

                if (!gameState.board[index]) {
                    gameState.board[index] = playerSymbol;
                    gameState.currentPlayer = playerSymbol === 'X' ? 'O' : 'X';
                }
                return gameState;
            });
        }

        // 更新棋盘显示
        function updateBoard(board) {
            document.querySelectorAll('.cell').forEach((cell, index) => {
                cell.textContent = board[index] || '';
            });
        }

        // 更新状态信息
        function updateStatus(gameState) {
            const statusElement = document.getElementById('status');
            if (gameState.winner) {
                statusElement.textContent = gameState.winner === 'draw' 
                    ? '平局!' 
                    : `${gameState.winner} 胜利!`;
                isGameActive = false;
            } else {
                statusElement.textContent = playerSymbol 
                    ? `你是 ${playerSymbol} | 当前玩家: ${gameState.currentPlayer}`
                    : '等待第二位玩家...';
            }
        }

        // 胜利检测
        function checkWinner(gameState) {
            const winPatterns = [
                [0,1,2], [3,4,5], [6,7,8], // 行
                [0,3,6], [1,4,7], [2,5,8], // 列
                [0,4,8], [2,4,6] // 对角线
            ];

            for (const pattern of winPatterns) {
                const [a,b,c] = pattern;
                if (gameState.board[a] && 
                    gameState.board[a] === gameState.board[b] && 
                    gameState.board[a] === gameState.board[c]) {
                    set(gameRef, { ...gameState, winner: gameState.board[a] });
                    return;
                }
            }

            if (gameState.board.every(cell => cell) && !gameState.winner) {
                set(gameRef, { ...gameState, winner: 'draw' });
            }
        }

        // 重置游戏
        function resetGame() {
            set(gameRef, {
                board: Array(9).fill(null),
                currentPlayer: 'X',
                players: 0,
                winner: null
            });
            isGameActive = true;
            playerSymbol = null;
        }
    </script>
</body>
</html>
