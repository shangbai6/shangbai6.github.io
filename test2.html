<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>联机井字棋</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f5f5f5;
        }
        .container {
            text-align: center;
            margin-top: 20px;
        }
        .game-info {
            margin: 20px 0;
            font-size: 18px;
        }
        .board {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            grid-template-rows: repeat(3, 100px);
            gap: 5px;
            margin: 20px 0;
        }
        .cell {
            width: 100px;
            height: 100px;
            background-color: #fff;
            border: 2px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .cell:hover {
            background-color: #eaeaea;
        }
        .room-controls {
            margin: 20px 0;
        }
        input, button {
            padding: 8px 12px;
            margin: 5px;
            font-size: 16px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .status {
            font-weight: bold;
            margin: 10px 0;
            font-size: 18px;
        }
        .room-id {
            font-weight: bold;
            font-size: 16px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>联机井字棋</h1>
        
        <div class="room-controls">
            <button id="create-game">创建新游戏</button>
            <div>
                <input type="text" id="join-input" placeholder="输入房间ID">
                <button id="join-game">加入游戏</button>
            </div>
        </div>
        
        <div class="room-id" id="room-display"></div>
        
        <div class="game-info">
            <div id="player-symbol"></div>
            <div id="turn-info"></div>
        </div>
        
        <div class="status" id="game-status"></div>
        
        <div class="board" id="game-board">
            <div class="cell" data-index="0"></div>
            <div class="cell" data-index="1"></div>
            <div class="cell" data-index="2"></div>
            <div class="cell" data-index="3"></div>
            <div class="cell" data-index="4"></div>
            <div class="cell" data-index="5"></div>
            <div class="cell" data-index="6"></div>
            <div class="cell" data-index="7"></div>
            <div class="cell" data-index="8"></div>
        </div>
        
        <button id="reset-game" style="display: none;">重新开始</button>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-analytics.js";
        import { getDatabase, ref, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAqbA4PN7uJr_lnIRHeqvvLJQXOHHoZW4E",
            authDomain: "test-8a5cb.firebaseapp.com",
            databaseURL: "https://test-8a5cb-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "test-8a5cb",
            storageBucket: "test-8a5cb.firebasestorage.app",
            messagingSenderId: "227317352826",
            appId: "1:227317352826:web:90d96f27a4dc5d96c16ec3",
            measurementId: "G-EMJ5ZVJXBE"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);

        // Game variables
        let currentPlayer = 'X';
        let gameActive = false;
        let gameId = null;
        let playerSymbol = null;
        let gameState = ['', '', '', '', '', '', '', '', ''];
        let playerId = Date.now().toString() + Math.floor(Math.random() * 1000);

        // DOM elements
        const cells = document.querySelectorAll('.cell');
        const gameBoard = document.getElementById('game-board');
        const gameStatus = document.getElementById('game-status');
        const roomDisplay = document.getElementById('room-display');
        const playerSymbolDisplay = document.getElementById('player-symbol');
        const turnInfo = document.getElementById('turn-info');
        const createGameBtn = document.getElementById('create-game');
        const joinGameBtn = document.getElementById('join-game');
        const joinInput = document.getElementById('join-input');
        const resetGameBtn = document.getElementById('reset-game');

        // Winning combinations
        const winningConditions = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8], // rows
            [0, 3, 6], [1, 4, 7], [2, 5, 8], // columns
            [0, 4, 8], [2, 4, 6]             // diagonals
        ];

        // Initialize game
        function initGame() {
            cells.forEach(cell => {
                cell.textContent = '';
                cell.addEventListener('click', () => handleCellClick(cell));
            });
        }

        // Create a new game
        createGameBtn.addEventListener('click', createGame);
        function createGame() {
            // Generate a random game ID
            gameId = Math.random().toString(36).substring(2, 8).toUpperCase();
            playerSymbol = 'X';
            
            // Initialize game in Firebase
            const gameRef = ref(database, 'games/' + gameId);
            set(gameRef, {
                board: ['', '', '', '', '', '', '', '', ''],
                currentPlayer: 'X',
                players: {
                    X: playerId
                },
                status: 'waiting'
            });
            
            // Listen for game updates
            listenToGameChanges(gameId);
            
            // Update UI
            roomDisplay.textContent = `房间ID: ${gameId}`;
            playerSymbolDisplay.textContent = `你的符号: ${playerSymbol}`;
            gameStatus.textContent = "等待对手加入...";
            
            // Show game board
            gameBoard.style.display = 'grid';
            gameActive = true;
        }

        // Join an existing game
        joinGameBtn.addEventListener('click', joinGame);
        function joinGame() {
            const roomId = joinInput.value.trim().toUpperCase();
            if (!roomId) {
                gameStatus.textContent = "请输入房间ID";
                return;
            }
            
            // Check if game exists
            const gameRef = ref(database, 'games/' + roomId);
            onValue(gameRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) {
                    gameStatus.textContent = "房间不存在";
                    return;
                }
                
                if (data.status === 'waiting') {
                    // Join as player O
                    gameId = roomId;
                    playerSymbol = 'O';
                    
                    // Update game status in Firebase
                    update(ref(database, 'games/' + gameId), {
                        players: {
                            ...data.players,
                            O: playerId
                        },
                        status: 'active'
                    });
                    
                    // Listen for game updates
                    listenToGameChanges(gameId);
                    
                    // Update UI
                    roomDisplay.textContent = `房间ID: ${gameId}`;
                    playerSymbolDisplay.textContent = `你的符号: ${playerSymbol}`;
                    gameBoard.style.display = 'grid';
                    gameActive = true;
                } else if (data.status === 'active') {
                    gameStatus.textContent = "游戏已满";
                }
            }, { onlyOnce: true });
        }

        // Listen for game updates from Firebase
        function listenToGameChanges(roomId) {
            const gameRef = ref(database, 'games/' + roomId);
            onValue(gameRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) return;
                
                // Update local game state
                gameState = data.board;
                currentPlayer = data.currentPlayer;
                
                // Update UI
                updateBoard();
                
                // Check game status
                if (data.status === 'active') {
                    if (data.currentPlayer === playerSymbol) {
                        turnInfo.textContent = "轮到你了";
                        gameStatus.textContent = "请落子";
                    } else {
                        turnInfo.textContent = "等待对手落子";
                        gameStatus.textContent = "";
                    }
                } else if (data.status === 'win') {
                    gameStatus.textContent = data.winner === playerSymbol ? "你赢了!" : "你输了!";
                    resetGameBtn.style.display = 'block';
                } else if (data.status === 'draw') {
                    gameStatus.textContent = "平局!";
                    resetGameBtn.style.display = 'block';
                }
            });
        }

        // Handle cell click
        function handleCellClick(cell) {
            const index = cell.getAttribute('data-index');
            
            // Check if valid move
            if (!gameActive || gameState[index] !== '' || currentPlayer !== playerSymbol) {
                return;
            }
            
            // Update game state in Firebase
            const boardCopy = [...gameState];
            boardCopy[index] = playerSymbol;
            
            // Check for win or draw
            const gameResult = checkGameResult(boardCopy, index);
            
            // Update Firebase
            const gameRef = ref(database, 'games/' + gameId);
            update(gameRef, {
                board: boardCopy,
                currentPlayer: playerSymbol === 'X' ? 'O' : 'X',
                ...gameResult
            });
        }

        // Check for win or draw
        function checkGameResult(board, lastMoveIndex) {
            const symbol = board[lastMoveIndex];
            
            // Check for win
            for (let condition of winningConditions) {
                if (
                    board[condition[0]] === symbol &&
                    board[condition[1]] === symbol &&
                    board[condition[2]] === symbol
                ) {
                    return {
                        status: 'win',
                        winner: symbol
                    };
                }
            }
            
            // Check for draw
            if (!board.includes('')) {
                return { status: 'draw' };
            }
            
            return {};
        }

        // Update board based on game state
        function updateBoard() {
            cells.forEach((cell, index) => {
                cell.textContent = gameState[index];
            });
        }

        // Reset game
        resetGameBtn.addEventListener('click', () => {
            if (gameId) {
                // Reset game in Firebase
                const gameRef = ref(database, 'games/' + gameId);
                update(gameRef, {
                    board: ['', '', '', '', '', '', '', '', ''],
                    currentPlayer: 'X',
                    status: 'active'
                });
                
                resetGameBtn.style.display = 'none';
            }
        });

        // Initialize the game
        initGame();
    </script>
</body>
</html>
