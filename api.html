<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>序列预测API</title>
    <!-- 加载TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
</head>
<body>
    <script>
        // 解析URL参数
        function getUrlParams() {
            const params = {};
            const queryString = window.location.search.substring(1);
            const regex = /([^&=]+)=([^&]*)/g;
            let m;
            
            while (m = regex.exec(queryString)) {
                params[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
            }
            
            return params;
        }

        // 处理输入序列长度为8
        function processInputSequence(sequence) {
            // 如果序列长度大于8，截取最后8个字符
            if (sequence.length > 8) {
                return sequence.slice(-8);
            }
            
            // 如果序列长度小于8，在前面用'A'填充
            if (sequence.length < 8) {
                return 'A'.repeat(8 - sequence.length) + sequence;
            }
            
            // 如果长度正好是8，直接返回
            return sequence;
        }

        // 主函数
        async function main() {
            try {
                // 获取URL参数
                const params = getUrlParams();
                const inputSequence = params.input || '';
                
                // 验证输入
                if (!inputSequence) {
                    throw new Error('缺少必需参数: input');
                }
                
                // 验证输入序列格式
                if (!/^[ABC]+$/.test(inputSequence)) {
                    throw new Error('输入序列只能包含A、B、C字符');
                }
                
                // 处理输入序列长度为8
                const processedSequence = processInputSequence(inputSequence);
                
                // 加载模型
                console.log('正在加载模型...');
                const model = await tf.loadLayersModel('./model.json');
                console.log('模型加载成功');
                
                // 准备输入数据
                // 将ABC转换为数值: A=0, B=1, C=2
                const numericalInput = processedSequence.split('').map(char => {
                    return char === 'A' ? 0 : char === 'B' ? 1 : 2;
                });
                
                // 创建3D张量 (形状: [batchSize, sequenceLength, features])
                const inputTensor = tf.tensor3d([numericalInput.map(x => [x])], [1, 8, 1]);
                
                // 进行预测
                console.log('正在进行预测...');
                const prediction = model.predict(inputTensor);
                const predictionData = await prediction.data();
                
                // 获取预测结果（取概率最高的字符）
                const probabilities = {
                    'A': predictionData[0],
                    'B': predictionData[1],
                    'C': predictionData[2]
                };
                
                // 找到概率最高的字符
                let maxProb = 0;
                let predictedChar = 'A';
                for (const char in probabilities) {
                    if (probabilities[char] > maxProb) {
                        maxProb = probabilities[char];
                        predictedChar = char;
                    }
                }
                
                // 返回JSON结果
                const response = {
                    status: 'success',
                    input: inputSequence,
                    processedInput: processedSequence,
                    sequenceLength: inputSequence.length,
                    prediction: predictedChar,
                    probabilities: probabilities,
                    timestamp: new Date().toISOString()
                };
                
                // 输出JSON响应
                document.body.innerHTML = `<pre>${JSON.stringify(response, null, 2)}</pre>`;
                
            } catch (error) {
                // 错误处理
                const errorResponse = {
                    status: 'error',
                    message: error.message,
                    timestamp: new Date().toISOString()
                };
                
                document.body.innerHTML = `<pre>${JSON.stringify(errorResponse, null, 2)}</pre>`;
                console.error('API错误:', error);
            }
        }

        // 执行主函数
        main();
    </script>
</body>
</html>
